<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>اتجاه القبلة على الخريطة</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+4poB5W+1T1yQ6HpyTXVq3KS88hNDRyMSh1GJ6L3w="
    crossorigin=""
  />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    #info {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <div id="info">جاري تحديد موقعك...</div>
  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-n0v/yxFp28ewJZZfZLCX5hpLuPvxPYZueh8iZz0j/tM="
    crossorigin=""
  ></script>

  <script>
    // حساب زاوية القبلة من موقع المستخدم
    function calculateQibla(lat, lon) {
      const kaabaLat = 21.4225;
      const kaabaLon = 39.8262;
      const rad = Math.PI / 180;
      const dLon = (kaabaLon - lon) * rad;
      const y = Math.sin(dLon) * Math.cos(kaabaLat * rad);
      const x = Math.cos(lat * rad) * Math.sin(kaabaLat * rad) -
                Math.sin(lat * rad) * Math.cos(kaabaLat * rad) * Math.cos(dLon);
      let brng = Math.atan2(y, x);
      brng = brng * (180 / Math.PI);
      return (brng + 360) % 360;
    }

    // بدء الخريطة بعد الحصول على الموقع
    function startMap(lat, lon) {
      const map = L.map('map').setView([lat, lon], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);

      // موقع المستخدم
      const userMarker = L.marker([lat, lon]).addTo(map).bindPopup('موقعك');

      // حساب زاوية القبلة
      const qiblaAngle = calculateQibla(lat, lon);

      // سهم القبلة كرمز مخصص
      const arrowIcon = L.divIcon({
        html: `<div style="
          transform: rotate(${qiblaAngle}deg);
          width: 40px; height: 40px;
          margin-left: -20px;
          margin-top: -20px;
          ">
          <svg viewBox="0 0 24 24" fill="#e74c3c" stroke="#c0392b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" >
            <path d="M12 2 L19 21 H5 L12 2 Z" />
          </svg>
          </div>`,
        className: '',
        iconSize: [40, 40],
        iconAnchor: [20, 20],
      });

      // إضافة سهم القبلة فوق موقع المستخدم
      L.marker([lat, lon], { icon: arrowIcon }).addTo(map).bindPopup('اتجاه القبلة');

      document.getElementById('info').textContent = 'تم تحديد موقعك واتجاه القبلة.';
    }

    // طلب الموقع
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          startMap(pos.coords.latitude, pos.coords.longitude);
        },
        (err) => {
          document.getElementById('info').textContent = 'تعذر الحصول على الموقع: ' + err.message;
        }
      );
    } else {
      document.getElementById('info').textContent = 'المتصفح لا يدعم تحديد الموقع.';
    }
  </script>
</body>
</html>
